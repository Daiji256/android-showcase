name: unit-test

on: pull_request

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  unit-test:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    permissions:
      contents: write
      pull-requests: write

    env:
      SCREENSHOTS_BRANCH_PREFIX: _screenshots_
      COMPANION_SCREENSHOTS_BRANCH_PREFIX: _companion_screenshots_
      ORPHAN_BRANCH_COMMITTER_NAME: github-actions[bot]
      ORPHAN_BRANCH_COMMITTER_EMAIL: 41898282+github-actions[bot]@users.noreply.github.com
      ORPHAN_BRANCH_MAX_AGE_SECONDS: 600 # TODO: 14 days

    steps:
      - name: Fetch all branches
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
        with:
          fetch-depth: 0

      - name: Delete outdated orphan branches
        shell: bash
        run: |
          now=$(date +%s)
          git branch -r --format="%(refname:lstrip=3)" | while read -r branch; do
            if [[ "$branch" != ${SCREENSHOTS_BRANCH_PREFIX}* && "$branch" != ${COMPANION_SCREENSHOTS_BRANCH_PREFIX}* ]]; then
              continue
            fi

            commit_count=$(git rev-list --count "origin/$branch")
            if [[ "$commit_count" -ne 1 ]]; then
              continue
            fi

            committer_name=$(git log -1 --format=%an "origin/$branch")
            if [[ "$committer_name" != "$ORPHAN_BRANCH_COMMITTER_NAME" ]]; then
              continue
            fi

            committer_email=$(git log -1 --format=%ae "origin/$branch")
            if [[ "$committer_email" != "$ORPHAN_BRANCH_COMMITTER_EMAIL" ]]; then
              continue
            fi

            commit_date=$(git log -1 --format=%ct "origin/$branch")
            age=$((now - commit_date))
            if [[ "$age" -lt "$ORPHAN_BRANCH_MAX_AGE_SECONDS" ]]; then
              continue
            fi

            git push origin --delete "$branch"
          done

      - name: Checkout base
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
        with:
          ref: ${{ github.event.pull_request.base.ref }}

      - name: Setup JDK
        uses: actions/setup-java@dded0888837ed1f317902acf8a20df0ad188d165 # v5.0.0
        with:
          distribution: temurin
          java-version: 21

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@ed408507eac070d1f99cc633dbcf757c94c7933a # v4.4.3

      - name: Get base files hash
        id: base-files-hash
        shell: bash
        run: |
          hash=$(git ls-files -z | xargs -0 sha256sum | sha256sum | awk '{print $1}')
          echo "hash=${hash:0:7}" >> "$GITHUB_OUTPUT"

      - name: Get base screenshots branch name
        id: base-screenshots-branch
        env:
          BASE_FILES_HASH: ${{ steps.base-files-hash.outputs.hash }}
        run: |
          echo "name=${SCREENSHOTS_BRANCH_PREFIX}${BASE_FILES_HASH}" >> "$GITHUB_OUTPUT"

      - name: Check if base screenshots branch exists
        id: check-base-screenshots-branch
        env:
          BRANCH: ${{ steps.base-screenshots-branch.outputs.name }}
        run: |
          if git show-ref --verify --quiet "refs/remotes/origin/${BRANCH}"; then
            echo "exists=true" >> "$GITHUB_OUTPUT"
          else
            echo "exists=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Record base screenshots
        if: ${{ steps.check-base-screenshots-branch.outputs.exists == 'false' }}
        run: ./gradlew recordRoborazziDebug

      - name: Upload base screenshots
        if: ${{ steps.check-base-screenshots-branch.outputs.exists == 'false' }}
        uses: daiji256/upload-to-orphan-branch@2d11054e099cf3fc45579e41ff3d90650abfb30b # v0.1.2
        with:
          branch: ${{ steps.base-screenshots-branch.outputs.name }}
          committer-name: ${{ env.ORPHAN_BRANCH_COMMITTER_NAME }}
          committer-email: ${{ env.ORPHAN_BRANCH_COMMITTER_EMAIL }}
          path: "**/build/outputs/roborazzi"

      - name: Checkout head
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0

      - name: Get head files hash
        id: head-files-hash
        shell: bash
        run: |
          hash=$(git ls-files -z | xargs -0 sha256sum | sha256sum | awk '{print $1}')
          echo "hash=${hash:0:7}" >> "$GITHUB_OUTPUT"

      - name: Get head screenshots branch name
        id: head-screenshots-branch
        env:
          HEAD_FILES_HASH: ${{ steps.head-files-hash.outputs.hash }}
        run: |
          echo "name=${SCREENSHOTS_BRANCH_PREFIX}${HEAD_FILES_HASH}" >> "$GITHUB_OUTPUT"

      - name: Get companion screenshots branch name
        id: companion-screenshots-branch
        env:
          BASE_FILES_HASH: ${{ steps.base-files-hash.outputs.hash }}
          HEAD_FILES_HASH: ${{ steps.head-files-hash.outputs.hash }}
        run: |
          echo "name=${COMPANION_SCREENSHOTS_BRANCH_PREFIX}${BASE_FILES_HASH}_${HEAD_FILES_HASH}" >> "$GITHUB_OUTPUT"

      - name: Check if head screenshots branch exists
        id: check-head-screenshots-branch
        env:
          BRANCH: ${{ steps.head-screenshots-branch.outputs.name }}
        run: |
          if git show-ref --verify --quiet "refs/remotes/origin/${BRANCH}"; then
            echo "exists=true" >> "$GITHUB_OUTPUT"
          else
            echo "exists=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Check if companion screenshots branch exists
        id: check-companion-screenshots-branch
        env:
          BRANCH: ${{ steps.companion-screenshots-branch.outputs.name }}
        run: |
          if git show-ref --verify --quiet "refs/remotes/origin/${BRANCH}"; then
            echo "exists=true" >> "$GITHUB_OUTPUT"
          else
            echo "exists=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Download base screenshots
        uses: daiji256/download-from-orphan-branch@f8dc5de6105bf1040e2004b225174a0ecce5ae59 # v0.1.1
        with:
          branch: ${{ steps.base-screenshots-branch.outputs.name }}

      - name: Run unit test
        shell: bash
        env:
          IS_HEAD_SCREENSHOTS_BRANCH_EXISTS: ${{ steps.check-head-screenshots-branch.outputs.exists }}
          IS_COMPANION_SCREENSHOTS_BRANCH_EXISTS: ${{ steps.check-companion-screenshots-branch.outputs.exists }}
        run: |
          if [[ "$IS_HEAD_SCREENSHOTS_BRANCH_EXISTS" == "true" && "$IS_COMPANION_SCREENSHOTS_BRANCH_EXISTS" == "true" ]]; then
            ./gradlew testDebugUnitTest
          else
            ./gradlew testDebugUnitTest -Proborazzi.test.record=true -Proborazzi.test.compare=true -Proborazzi.cleanupOldScreenshots=true
          fi

      - name: Display unit test report
        if: ${{ !cancelled() }}
        uses: dorny/test-reporter@dc3a92680fcc15842eef52e8c4606ea7ce6bd3f3 # v2.1.1
        with:
          name: unit-test-report
          path: "**/build/test-results/**/TEST-*.xml"
          reporter: java-junit

      - name: Upload head screenshots
        if: ${{ !cancelled() && steps.check-head-screenshots-branch.outputs.exists == 'false' }}
        uses: daiji256/upload-to-orphan-branch@2d11054e099cf3fc45579e41ff3d90650abfb30b # v0.1.2
        with:
          branch: ${{ steps.head-screenshots-branch.outputs.name }}
          committer-name: ${{ env.ORPHAN_BRANCH_COMMITTER_NAME }}
          committer-email: ${{ env.ORPHAN_BRANCH_COMMITTER_EMAIL }}
          path: |
            **/build/outputs/roborazzi
            !**/build/outputs/roborazzi/*_compare.png
            !**/build/outputs/roborazzi/*_actual.png

      - name: Upload companion screenshots
        if: ${{ !cancelled() && steps.check-companion-screenshots-branch.outputs.exists == 'false' }}
        uses: daiji256/upload-to-orphan-branch@2d11054e099cf3fc45579e41ff3d90650abfb30b # v0.1.2
        with:
          branch: ${{ steps.companion-screenshots-branch.outputs.name }}
          committer-name: ${{ env.ORPHAN_BRANCH_COMMITTER_NAME }}
          committer-email: ${{ env.ORPHAN_BRANCH_COMMITTER_EMAIL }}
          path: "**/build/outputs/roborazzi/*_compare.png"

      - name: Delete outdated report
        env:
          GH_TOKEN: ${{ github.token }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          REPOSITORY: ${{ github.repository }}
        run: |
          comment_ids=$(
            gh api "repos/${REPOSITORY}/issues/${PR_NUMBER}/comments" |
            jq -r '
              .[]
              | select(.user.login == "github-actions[bot]")
              | select(.body | contains("<!-- screenshot-test-report -->"))
              | .id'
          )
          for comment_id in $comment_ids; do
            gh api -X DELETE "repos/${REPOSITORY}/issues/comments/${comment_id}"
          done

      - name: Post report
        shell: bash
        env:
          COMPANION_BRANCH: ${{ steps.companion-screenshots-branch.outputs.name }}
          REPORT_FILE: screenshot-test-report.md
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: |
          mapfile -d "" files < <(find . -type f -path "**/build/outputs/roborazzi/*_compare.png" -print0)
          if [ "${#files[@]}" -eq 0 ]; then
            exit 0
          fi
          {
            echo "<!-- screenshot-test-report -->"
            echo ""
            echo "> [!NOTE]"
            echo "> Differences found in ${#files[@]} screenshots."
            echo ""
            echo "<details><summary>Expand for details</summary>"
            for file in "${files[@]}"; do
              echo ""
              echo "\`$(basename "$file" | sed 's/_compare\.png$//')\`"
              echo "![](https://github.com/${{ github.repository }}/blob/${COMPANION_BRANCH}/${file}?raw=true)"
            done
            echo ""
            echo "</details>"
          } >> "$REPORT_FILE"
          gh pr comment "$PR_NUMBER" --body-file "$REPORT_FILE"
