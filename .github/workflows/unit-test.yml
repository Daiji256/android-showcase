name: unit-test

on: pull_request

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  unit-test:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    permissions:
      contents: write

    env:
      SCREENSHOTS_BRANCH_PREFIX: _screenshots_
      SCREENSHOTS_COMMITTER_NAME: github-actions[bot]
      SCREENSHOTS_COMMITTER_EMAIL: 41898282+github-actions[bot]@users.noreply.github.com
      SCREENSHOTS_COMMIT_MESSAGE: screenshots
      SCREENSHOTS_MAX_AGE_SECONDS: 600 # TODO: 14 days
      COMPANION_SCREENSHOTS_BRANCH_PREFIX: _companion_screenshots_
      COMPANION_SCREENSHOTS_COMMITTER_NAME: github-actions[bot]
      COMPANION_SCREENSHOTS_COMMITTER_EMAIL: 41898282+github-actions[bot]@users.noreply.github.com
      COMPANION_SCREENSHOTS_COMMIT_MESSAGE: screenshots
      COMPANION_SCREENSHOTS_MAX_AGE_SECONDS: 600 # TODO: 14 days

    steps:
      - name: Checkout base
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
        with:
          ref: ${{ github.event.pull_request.base.ref }}
          fetch-depth: 0

      - name: Setup JDK
        uses: actions/setup-java@dded0888837ed1f317902acf8a20df0ad188d165 # v5.0.0
        with:
          distribution: temurin
          java-version: 21

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@ed408507eac070d1f99cc633dbcf757c94c7933a # v4.4.3

      - name: Get base files hash
        id: base-files-hash
        shell: bash
        run: |
          hash=$(git ls-files -z | xargs -0 sha256sum | sha256sum | awk '{print $1}')
          echo "hash=${hash:0:7}" >> "$GITHUB_OUTPUT"

      - name: Get base screenshots branch name
        id: base-screenshots-branch
        shell: bash
        env:
          BASE_FILES_HASH: ${{ steps.base-files-hash.outputs.hash }}
        run: |
          echo "name=${SCREENSHOTS_BRANCH_PREFIX}${BASE_FILES_HASH}" >> "$GITHUB_OUTPUT"

      - name: Check if base screenshots branch exists
        id: check-base-screenshots-branch
        shell: bash
        env:
          BRANCH: ${{ steps.base-screenshots-branch.outputs.name }}
        run: |
          if git show-ref --verify --quiet "refs/remotes/origin/${BRANCH}"; then
            echo "exists=true" >> "$GITHUB_OUTPUT"
          else
            echo "exists=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Download base screenshots
        if: ${{ steps.check-base-screenshots-branch.outputs.exists == 'true' }}
        uses: daiji256/download-from-orphan-branch@04e2d3ac47d18764bb143b5d5653f898ec54e305 # v0.1.0
        with:
          branch: ${{ steps.base-screenshots-branch.outputs.name }}

      - name: Record base screenshots
        if: ${{ steps.check-base-screenshots-branch.outputs.exists == 'false' }}
        shell: bash
        run: ./gradlew recordRoborazziDebug

      - name: Upload base screenshots
        if: ${{ steps.check-base-screenshots-branch.outputs.exists == 'false' }}
        uses: daiji256/upload-to-orphan-branch@c7b7f47558b9ebd00985945e85b6a2ff3d0ce883 # v0.1.1
        with:
          branch: ${{ steps.base-screenshots-branch.outputs.name }}
          committer-name: ${{ env.SCREENSHOTS_COMMITTER_NAME }}
          committer-email: ${{ env.SCREENSHOTS_COMMITTER_EMAIL }}
          commit-message: ${{ env.SCREENSHOTS_COMMIT_MESSAGE }}
          path: "**/build/outputs/roborazzi"

      - name: Checkout head
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0

      - name: Get head files hash
        id: head-files-hash
        shell: bash
        run: |
          hash=$(git ls-files -z | xargs -0 sha256sum | sha256sum | awk '{print $1}')
          echo "hash=${hash:0:7}" >> "$GITHUB_OUTPUT"

      - name: Get head screenshots branch name
        id: head-screenshots-branch
        shell: bash
        env:
          HEAD_FILES_HASH: ${{ steps.head-files-hash.outputs.hash }}
        run: |
          echo "name=${SCREENSHOTS_BRANCH_PREFIX}${HEAD_FILES_HASH}" >> "$GITHUB_OUTPUT"

      - name: Get companion screenshots branch name
        id: companion-screenshots-branch
        shell: bash
        env:
          BASE_FILES_HASH: ${{ steps.base-files-hash.outputs.hash }}
          HEAD_FILES_HASH: ${{ steps.head-files-hash.outputs.hash }}
        run: |
          echo "name=${COMPANION_SCREENSHOTS_BRANCH_PREFIX}${BASE_FILES_HASH}_${HEAD_FILES_HASH}" >> "$GITHUB_OUTPUT"

      - name: Check if head screenshots branch exists
        id: check-head-screenshots-branch
        shell: bash
        env:
          BRANCH: ${{ steps.head-screenshots-branch.outputs.name }}
        run: |
          if git show-ref --verify --quiet "refs/remotes/origin/${BRANCH}"; then
            echo "exists=true" >> "$GITHUB_OUTPUT"
          else
            echo "exists=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Check if companion screenshots branch exists
        id: check-companion-screenshots-branch
        shell: bash
        env:
          BRANCH: ${{ steps.companion-screenshots-branch.outputs.name }}
        run: |
          if git show-ref --verify --quiet "refs/remotes/origin/${BRANCH}"; then
            echo "exists=true" >> "$GITHUB_OUTPUT"
          else
            echo "exists=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Run unit test
        shell: bash
        env:
          IS_HEAD_SCREENSHOTS_BRANCH_EXISTS: ${{ steps.check-head-screenshots-branch.outputs.exists }}
          IS_COMPANION_SCREENSHOTS_BRANCH_EXISTS: ${{ steps.check-base-screenshots-branch.outputs.exists }}
        run: |
          if [ "$IS_HEAD_SCREENSHOTS_BRANCH_EXISTS" = "true" ] && [ "$IS_COMPANION_SCREENSHOTS_BRANCH_EXISTS" = "true" ]; then
            ./gradlew testDebugUnitTest
          else
            ./gradlew testDebugUnitTest -Proborazzi.test.compare=true
          fi

      - name: Display unit test report
        if: ${{ !cancelled() }}
        uses: dorny/test-reporter@dc3a92680fcc15842eef52e8c4606ea7ce6bd3f3 # v2.1.1
        with:
          name: unit-test-report
          path: "**/build/test-results/**/TEST-*.xml"
          reporter: java-junit

      - name: Upload head screenshots
        if: ${{ !cancelled() && steps.check-head-screenshots-branch.outputs.exists == 'false' }}
        uses: daiji256/upload-to-orphan-branch@c7b7f47558b9ebd00985945e85b6a2ff3d0ce883 # v0.1.1
        with:
          branch: ${{ steps.head-screenshots-branch.outputs.name }}
          committer-name: ${{ env.SCREENSHOTS_COMMITTER_NAME }}
          committer-email: ${{ env.SCREENSHOTS_COMMITTER_EMAIL }}
          commit-message: ${{ env.SCREENSHOTS_COMMIT_MESSAGE }}
          path: |
            **/build/outputs/roborazzi
            !**/build/outputs/roborazzi/*_compare.png

      - name: Upload companion screenshots
        if: ${{ !cancelled() && steps.check-companion-screenshots-branch.outputs.exists == 'false' }}
        uses: daiji256/upload-to-orphan-branch@c7b7f47558b9ebd00985945e85b6a2ff3d0ce883 # v0.1.1
        with:
          branch: ${{ steps.companion-screenshots-branch.outputs.name }}
          committer-name: ${{ env.COMPANION_SCREENSHOTS_COMMITTER_NAME }}
          committer-email: ${{ env.COMPANION_SCREENSHOTS_COMMITTER_EMAIL }}
          commit-message: ${{ env.COMPANION_SCREENSHOTS_COMMIT_MESSAGE }}
          path: "**/build/outputs/roborazzi/*_compare.png"

  screenshot-test-results:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs:
      - unit-test
    permissions:
      contents: write
      pull-requests: write
    env:
      COMPANION_BRANCH: _companion_${{ github.base_ref }}_${{ github.head_ref }}
      REPORT_FILE: report.md

    steps:
      - name: Checkout
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
        with:
          fetch-depth: 0

      - name: Switch _companion branch
        run: |
          git branch -D "$COMPANION_BRANCH" || true
          git checkout --orphan "$COMPANION_BRANCH"
          git rm -rf .

      - name: Download screenshot test results
        uses: actions/download-artifact@634f93cb2916e3fdff6788551b99b062d0335ce0 # v5.0.0
        continue-on-error: true
        with:
          name: screenshot-test-results
          path: screenshot-test-results

      - name: Create report
        id: create-report
        run: |
          files=$(find . -type f -name "*_compare.png" | sort)
          if [ -n "$files" ]; then
            echo "<!-- screenshot-test-report -->" >> "$REPORT_FILE"
            echo "" >> "$REPORT_FILE"
            echo "> [!NOTE]" >> "$REPORT_FILE"
            echo "> Differences found in $(echo "$files" | wc -l) screenshots." >> "$REPORT_FILE"
            echo "" >> "$REPORT_FILE"
            echo "<details><summary>Expand for details</summary>" >> "$REPORT_FILE"
            for file in $files; do
              image_path="https://github.com/${{ github.repository }}/blob/$COMPANION_BRANCH/$file"
              echo "" >> "$REPORT_FILE"
              echo "\`$(basename "$file" | sed 's/_compare\.png$//')\`" >> "$REPORT_FILE"
              echo "![]($image_path?raw=true)" >> "$REPORT_FILE"
              git add "$file"
            done
            echo "" >> "$REPORT_FILE"
            echo "</details>" >> "$REPORT_FILE"
            echo "report_present=true" >> "$GITHUB_OUTPUT"
            git config --global user.name screenshot-bot
            git config --global user.email 41898282+github-actions[bot]@users.noreply.github.com
            git commit -m "screenshot-test-results"
            git push -f origin HEAD:"$COMPANION_BRANCH"
          else
            echo "report_present=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Delete outdated report
        env:
          GH_TOKEN: ${{ github.token }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          REPOSITORY: ${{ github.repository }}
        run: |
          comment_ids=$(
            gh api "repos/${REPOSITORY}/issues/${PR_NUMBER}/comments" |
            jq -r '
              .[]
              | select(.user.login == "github-actions[bot]")
              | select(.body | contains("<!-- screenshot-test-report -->"))
              | .id'
          )
          for comment_id in $comment_ids; do
            gh api -X DELETE "repos/${REPOSITORY}/issues/comments/${comment_id}"
          done

      - name: Post report
        if: ${{ success() && !cancelled() && steps.create-report.outputs.report_present == 'true' }}
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: gh pr comment $PR_NUMBER --body-file $REPORT_FILE

      - name: Delete outdated _companion branches
        run: |
          now=$(date +%s)
          git branch -r --format="%(refname:lstrip=3)" | grep _companion | while read -r branch; do
            last_commit_date=$(git log -1 --format=%ct "origin/$branch")
            if [ $((now - last_commit_date)) -gt 2592000 ]; then
              git push origin --delete "$branch"
            fi
          done
