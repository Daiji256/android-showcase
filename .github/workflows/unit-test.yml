name: unit-test

on: pull_request

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number }}
  cancel-in-progress: true

defaults:
  run:
    shell: bash

env:
  SCREENSHOTS_BRANCH_PREFIX: _screenshots_
  COMPANION_SCREENSHOTS_BRANCH_PREFIX: _companion_screenshots_
  ORPHAN_BRANCH_COMMITTER_NAME: github-actions[bot]
  ORPHAN_BRANCH_COMMITTER_EMAIL: 41898282+github-actions[bot]@users.noreply.github.com
  ORPHAN_BRANCH_MAX_AGE_SECONDS: 3600 # TODO: 1209600

jobs:
  unit-test:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    needs: cleanup
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout base
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
        with:
          ref: ${{ github.event.pull_request.base.ref }}
          fetch-depth: 0

      - name: Setup JDK
        uses: actions/setup-java@dded0888837ed1f317902acf8a20df0ad188d165 # v5.0.0
        with:
          distribution: temurin
          java-version: 21

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@ed408507eac070d1f99cc633dbcf757c94c7933a # v4.4.3

      - name: Get base files hash
        id: base-files-hash
        run: |
          hash=$(git ls-files -z | xargs -0 sha256sum | sha256sum | awk '{print $1}')
          echo "hash=${hash:0:7}" >> "$GITHUB_OUTPUT"

      - name: Get base screenshots branch name
        id: base-screenshots-branch
        env:
          BASE_FILES_HASH: ${{ steps.base-files-hash.outputs.hash }}
        run: |
          echo "name=${SCREENSHOTS_BRANCH_PREFIX}${BASE_FILES_HASH}" >> "$GITHUB_OUTPUT"

      - name: Check if base screenshots branch exists
        id: check-base-screenshots-branch
        env:
          BRANCH: ${{ steps.base-screenshots-branch.outputs.name }}
        run: |
          if git show-ref --verify --quiet "refs/remotes/origin/${BRANCH}"; then
            echo "exists=true" >> "$GITHUB_OUTPUT"
          else
            echo "exists=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Record base screenshots
        if: ${{ steps.check-base-screenshots-branch.outputs.exists == 'false' }}
        run: ./gradlew recordRoborazziDebug

      - name: Upload base screenshots
        if: ${{ steps.check-base-screenshots-branch.outputs.exists == 'false' }}
        uses: daiji256/upload-to-orphan-branch@2d11054e099cf3fc45579e41ff3d90650abfb30b # v0.1.2
        with:
          branch: ${{ steps.base-screenshots-branch.outputs.name }}
          committer-name: ${{ env.ORPHAN_BRANCH_COMMITTER_NAME }}
          committer-email: ${{ env.ORPHAN_BRANCH_COMMITTER_EMAIL }}
          path: "**/build/outputs/roborazzi"

      - name: Checkout head
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0

      - name: Get head files hash
        id: head-files-hash
        run: |
          hash=$(git ls-files -z | xargs -0 sha256sum | sha256sum | awk '{print $1}')
          echo "hash=${hash:0:7}" >> "$GITHUB_OUTPUT"

      - name: Get head screenshots branch name
        id: head-screenshots-branch
        env:
          HEAD_FILES_HASH: ${{ steps.head-files-hash.outputs.hash }}
        run: |
          echo "name=${SCREENSHOTS_BRANCH_PREFIX}${HEAD_FILES_HASH}" >> "$GITHUB_OUTPUT"

      - name: Get companion screenshots branch name
        id: companion-screenshots-branch
        env:
          BASE_FILES_HASH: ${{ steps.base-files-hash.outputs.hash }}
          HEAD_FILES_HASH: ${{ steps.head-files-hash.outputs.hash }}
        run: |
          echo "name=${COMPANION_SCREENSHOTS_BRANCH_PREFIX}${BASE_FILES_HASH}_${HEAD_FILES_HASH}" >> "$GITHUB_OUTPUT"

      - name: Check if head screenshots branch exists
        id: check-head-screenshots-branch
        env:
          BRANCH: ${{ steps.head-screenshots-branch.outputs.name }}
        run: |
          if git show-ref --verify --quiet "refs/remotes/origin/${BRANCH}"; then
            echo "exists=true" >> "$GITHUB_OUTPUT"
          else
            echo "exists=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Check if companion screenshots branch exists
        id: check-companion-screenshots-branch
        env:
          BRANCH: ${{ steps.companion-screenshots-branch.outputs.name }}
        run: |
          if git show-ref --verify --quiet "refs/remotes/origin/${BRANCH}"; then
            echo "exists=true" >> "$GITHUB_OUTPUT"
          else
            echo "exists=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Download base screenshots
        uses: daiji256/download-from-orphan-branch@f8dc5de6105bf1040e2004b225174a0ecce5ae59 # v0.1.1
        with:
          branch: ${{ steps.base-screenshots-branch.outputs.name }}

      - name: Run unit test
        env:
          HEAD_EXISTS: ${{ steps.check-head-screenshots-branch.outputs.exists }}
          COMPANION_EXISTS: ${{ steps.check-companion-screenshots-branch.outputs.exists }}
        run: |
          if [[ "$HEAD_EXISTS" == "true" && "$COMPANION_EXISTS" == "true" ]]; then
            ./gradlew testDebugUnitTest
          else
            ./gradlew testDebugUnitTest \
              -Proborazzi.test.record=true \
              -Proborazzi.test.compare=true \
              -Proborazzi.cleanupOldScreenshots=true
          fi

      - name: Display unit test report
        if: ${{ !cancelled() }}
        uses: dorny/test-reporter@dc3a92680fcc15842eef52e8c4606ea7ce6bd3f3 # v2.1.1
        with:
          name: unit-test-report
          path: "**/build/test-results/**/TEST-*.xml"
          reporter: java-junit

      - name: Upload head screenshots
        if: ${{ !cancelled() && steps.check-head-screenshots-branch.outputs.exists == 'false' }}
        uses: daiji256/upload-to-orphan-branch@2d11054e099cf3fc45579e41ff3d90650abfb30b # v0.1.2
        with:
          branch: ${{ steps.head-screenshots-branch.outputs.name }}
          committer-name: ${{ env.ORPHAN_BRANCH_COMMITTER_NAME }}
          committer-email: ${{ env.ORPHAN_BRANCH_COMMITTER_EMAIL }}
          path: |
            **/build/outputs/roborazzi
            !**/build/outputs/roborazzi/*_compare.png
            !**/build/outputs/roborazzi/*_actual.png

      - name: Upload companion screenshots
        if: ${{ !cancelled() && steps.check-companion-screenshots-branch.outputs.exists == 'false' }}
        uses: daiji256/upload-to-orphan-branch@2d11054e099cf3fc45579e41ff3d90650abfb30b # v0.1.2
        with:
          branch: ${{ steps.companion-screenshots-branch.outputs.name }}
          committer-name: ${{ env.ORPHAN_BRANCH_COMMITTER_NAME }}
          committer-email: ${{ env.ORPHAN_BRANCH_COMMITTER_EMAIL }}
          path: "**/build/outputs/roborazzi/*_compare.png"

      - name: Post report
        env:
          COMPANION_BRANCH: ${{ steps.companion-screenshots-branch.outputs.name }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: |
          mapfile -d "" files < <(find . -type f -path "**/build/outputs/roborazzi/*_compare.png" -print0)
          if [[ ${#files[@]} -eq 0 ]]; then
            exit 0
          fi
          report="<!-- screenshot-test-report -->"$'\n'
          report+=$'\n'
          report+="> [!NOTE]"$'\n'
          report+="> Differences found in ${#files[@]} screenshots."$'\n'
          report+=$'\n'
          report+="<details><summary>Expand for details</summary>"$'\n'
          for file in "${files[@]}"; do
            report+=$'\n'
            report+="\`$(basename "$file")\`"$'\n'
            report+="![](https://github.com/${GITHUB_REPOSITORY}/blob/${COMPANION_BRANCH}/${file}?raw=true)"$'\n'
          done
          report+=$'\n'
          report+="</details>"$'\n'
          gh pr comment "$PR_NUMBER" --body "$report"

  orphan-branche-names:
    runs-on: ubuntu-latest
    timeout-minutes: 5

    outputs:
      base-screenshots: ${{ steps.branch-names.outputs.base }}
      head-screenshots: ${{ steps.branch-names.outputs.head }}
      companion-screenshots: ${{ steps.branch-names.outputs.companion }}

    steps:
      - name: Checkout base
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
        with:
          ref: ${{ github.event.pull_request.base.ref }}

      - name: Get base files hash
        id: base
        run: |
          hash=$(git ls-files -z | xargs -0 sha256sum | sha256sum | awk '{print $1}')
          echo "hash=${hash:0:7}" >> "$GITHUB_OUTPUT"

      - name: Checkout head
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
        with:
          ref: ${{ github.event.pull_request.head.ref }}

      - name: Get head files hash
        id: head
        run: |
          hash=$(git ls-files -z | xargs -0 sha256sum | sha256sum | awk '{print $1}')
          echo "hash=${hash:0:7}" >> "$GITHUB_OUTPUT"

      - name: Get branch names
        id: branch-names
        env:
          BASE_FILES_HASH: ${{ steps.base.outputs.hash }}
          HEAD_FILES_HASH: ${{ steps.head.outputs.hash }}
        run: |
          echo "base=${SCREENSHOTS_BRANCH_PREFIX}${BASE_FILES_HASH}" >> "$GITHUB_OUTPUT"
          echo "head=${SCREENSHOTS_BRANCH_PREFIX}${HEAD_FILES_HASH}" >> "$GITHUB_OUTPUT"
          echo "companion=${COMPANION_SCREENSHOTS_BRANCH_PREFIX}${BASE_FILES_HASH}_${HEAD_FILES_HASH}" >> "$GITHUB_OUTPUT"

  cleanup:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout (fetch all)
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
        with:
          fetch-depth: 0

      - name: Delete outdated orphan branches
        run: |
          now=$(date +%s)
          git branch -r --format="%(refname:lstrip=3)" | while read -r branch; do
            if [[ "$branch" != ${SCREENSHOTS_BRANCH_PREFIX}* && "$branch" != ${COMPANION_SCREENSHOTS_BRANCH_PREFIX}* ]]; then
              continue
            fi

            commit_count=$(git rev-list --count "origin/$branch")
            if [[ "$commit_count" -ne 1 ]]; then
              continue
            fi

            committer_name=$(git log -1 --format=%an "origin/$branch")
            if [[ "$committer_name" != "$ORPHAN_BRANCH_COMMITTER_NAME" ]]; then
              continue
            fi

            committer_email=$(git log -1 --format=%ae "origin/$branch")
            if [[ "$committer_email" != "$ORPHAN_BRANCH_COMMITTER_EMAIL" ]]; then
              continue
            fi

            commit_date=$(git log -1 --format=%ct "origin/$branch")
            age=$((now - commit_date))
            if [[ "$age" -lt "$ORPHAN_BRANCH_MAX_AGE_SECONDS" ]]; then
              continue
            fi

            git push origin --delete "$branch"
          done

      - name: Delete outdated screenshot test report comments
        env:
          GH_TOKEN: ${{ github.token }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: |
          comment_ids=$(
            gh api "repos/${GITHUB_REPOSITORY}/issues/${PR_NUMBER}/comments" |
            jq -r '
              .[]
              | select(.user.login == "github-actions[bot]")
              | select(.body | contains("<!-- screenshot-test-report -->"))
              | .id'
          )
          for comment_id in $comment_ids; do
            gh api -X DELETE "repos/${GITHUB_REPOSITORY}/issues/comments/${comment_id}"
          done
